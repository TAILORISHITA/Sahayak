<!-- done  -->
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UniERP - Support Center</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', sans-serif;
    }

    body {
      display: flex;
      height: 100vh;
      background: #f8fafc;
      color: #111827;
    }

    /* Sidebar */
    .sidebar {
      width: 240px;
      background: #fff;
      border-right: 1px solid #e5e7eb;
      padding: 20px 0;
    }

    .sidebar h2 {
      font-size: 18px;
      font-weight: 600;
      padding: 0 20px 20px;
    }

    .sidebar ul {
      list-style: none;
    }

    .sidebar ul li {
      padding: 12px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      color: #374151;
      transition: background 0.2s;
    }

    .sidebar ul li:hover,
    .sidebar ul li.active {
      background: #f3f4f6;
      color: #111827;
    }

    .sidebar ul li.active {
      background: #2563eb;
      color: #fff;
      border-radius: 6px;
    }

    /* Topbar */
    .topbar {
      height: 64px;
      background: #fff;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 18px;
      font-weight: 600;
    }

    .logo span {
      color: #2563eb;
    }

    .top-actions {
      display: flex;
      gap: 16px;
      align-items: center;
    }

    .user-info {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }

    .user-id-display {
      font-size: 12px;
      color: #6b7280;
    }

    .btn-publish {
      background: #2563eb;
      color: #fff;
      padding: 6px 14px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
    }

    /* Main */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .content {
      padding: 20px;
      overflow-y: auto;
    }

    h1 {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .cards {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin: 20px 0;
    }

    .card {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 20px;
    }

    .card h2 {
      font-size: 18px;
      margin-bottom: 6px;
    }

    .card p {
      font-size: 14px;
      color: #6b7280;
    }

    .card .value {
      font-size: 22px;
      font-weight: 600;
      color: #2563eb;
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      border-bottom: 1px solid #e5e7eb;
    }

    .tab {
      padding: 10px 20px;
      cursor: pointer;
      font-weight: 500;
      color: #374151;
    }

    .tab.active {
      border-bottom: 2px solid #2563eb;
      color: #2563eb;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* FAQ */
    .faq-search {
      padding: 12px;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      margin-bottom: 16px;
      width: 100%;
    }

    .faq-item {
      background: #fff;
      border: 1px solid #e5e7eb;
      padding: 14px;
      margin-bottom: 10px;
      border-radius: 6px;
      transition: all 0.3s ease;
    }

    .faq-item:hover {
      border-color: #2563eb;
      box-shadow: 0 2px 8px rgba(37, 99, 235, 0.1);
    }

    .faq-item strong {
      display: block;
      cursor: pointer;
      font-size: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .faq-item strong::after {
      content: '+';
      font-size: 18px;
      transition: transform 0.3s ease;
    }

    .faq-item.active strong::after {
      transform: rotate(45deg);
    }

    .faq-item p {
      margin-top: 10px;
      font-size: 14px;
      color: #555;
      display: none;
      line-height: 1.5;
    }

    .faq-item.active p {
      display: block;
    }

    .faq-category {
      color: #2563eb;
      font-size: 12px;
      background: #eff6ff;
      padding: 2px 8px;
      border-radius: 12px;
      margin-bottom: 8px;
      display: inline-block;
    }

    .loading-faqs {
      text-align: center;
      padding: 40px;
      color: #6b7280;
    }

    .loading-faqs i {
      animation: spin 1s linear infinite;
      margin-right: 8px;
    }

    @keyframes spin {
      from {
        transform: rotate(0deg);
      }

      to {
        transform: rotate(360deg);
      }
    }

    .no-results {
      text-align: center;
      padding: 40px;
      color: #6b7280;
    }

    /* Tickets */
    .ticket {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      padding: 16px;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .ticket-info {
      flex-grow: 1;
    }

    .ticket-info strong {
      display: block;
      margin-bottom: 4px;
    }

    .status {
      font-size: 12px;
      padding: 2px 6px;
      border-radius: 4px;
      text-transform: capitalize;
    }

    .status.open {
      background: #fee2e2;
      color: #b91c1c;
    }

    .status.in-progress {
      background: #fef9c3;
      color: #b45309;
    }

    .status.resolved {
      background: #dcfce7;
      color: #166534;
    }

    .btn.view-details-btn {
      background: #06b6d4;
      color: #fff;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
    }

    .no-tickets {
      text-align: center;
      padding: 40px;
      color: #6b7280;
    }

    /* Contact form */
    .form-group {
      margin-bottom: 12px;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 10px;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
    }

    .btn-submit {
      background: #2563eb;
      color: #fff;
      padding: 10px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      width: 100%;
    }

    /* Chat */
    .chat-box {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      padding: 16px;
      height: 400px;
      display: flex;
      flex-direction: column;
    }

    .messages {
      flex: 1;
      overflow-y: auto;
      margin-bottom: 10px;
    }

    .msg {
      background: #f3f4f6;
      padding: 8px 12px;
      border-radius: 6px;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .msg.user {
      background: #2563eb;
      color: #fff;
      align-self: flex-end;
    }

    .chat-input {
      display: flex;
      gap: 8px;
    }

    .chat-input input {
      flex: 1;
      padding: 10px;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
    }

    .chat-input button {
      background: #2563eb;
      color: #fff;
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    /* Custom Message Box */
    .custom-alert {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      display: none;
      text-align: center;
      min-width: 300px;
    }

    .custom-alert-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
      display: none;
    }

    .custom-alert-close {
      margin-top: 15px;
      padding: 8px 16px;
      background-color: #2563eb;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
  </style>
</head>

<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <h2>Student Portal</h2>
    <ul>
      <li><i class="fa fa-home"></i> Dashboard</li>
      <li><i class="fa fa-user"></i> Onboarding</li>
      <li><i class="fa fa-book"></i> Courses</li>
      <li><i class="fa fa-tasks"></i> Assignments</li>
      <li><i class="fa fa-graduation-cap"></i> Grades</li>
      <li><i class="fa fa-calendar-check"></i> Attendance</li>
      <li><i class="fa fa-credit-card"></i> Fees & Payments</li>
      <li><i class="fa fa-map"></i> Campus Info</li>
      <li><i class="fa fa-calendar"></i> Events</li>
      <li class="active"><i class="fa fa-headset"></i> Support</li>
    </ul>
  </div>

  <!-- Main -->
  <div class="main">
    <div class="topbar">
      <div class="logo"><span>UniERP</span> University Management</div>
      <div class="top-actions">
        <div class="user-info">
          <span class="user-id-display"></span>
        </div>
        <i class="fa fa-bell"></i>
        <i class="fa fa-user"></i>
        <div class="btn-publish">Publish</div>
      </div>
    </div>
    <div class="content">
      <h1>Support Center</h1>
      <p>Get help with portal, email setup, and academic queries</p>

      <!-- Cards -->
      <div class="cards">
        <div class="card">
          <h2>Open Tickets</h2>
          <div class="value" id="openTicketsValue">...</div>
          <p>Active support requests</p>
        </div>
        <div class="card">
          <h2>Avg Response Time</h2>
          <div class="value">2.5h</div>
          <p>Better than average</p>
        </div>
        <div class="card">
          <h2>Resolved Issues</h2>
          <div class="value">12</div>
          <p>This semester</p>
        </div>
        <div class="card">
          <h2>Satisfaction Rate</h2>
          <div class="value">4.8/5</div>
          <p>Support quality</p>
        </div>
      </div>

      <!-- Tabs -->
      <div class="tabs">
        <div class="tab active" data-tab="faq">FAQs</div>
        <div class="tab" data-tab="tickets">My Tickets</div>
        <div class="tab" data-tab="contact">Contact Support</div>
        <div class="tab" data-tab="chat">Quick Chat</div>
      </div>

      <!-- FAQ -->
      <div id="faq" class="tab-content active">
        <input class="faq-search" id="faqSearch" placeholder="Search FAQs...">
        <div id="faqContainer">
          <div class="loading-faqs">
            <i class="fa fa-spinner"></i>
            Loading FAQs...
          </div>
        </div>
      </div>

      <!-- Tickets -->
      <div id="tickets" class="tab-content">
        <div id="ticketsContainer">
          <div class="loading-faqs">
            <i class="fa fa-spinner"></i>
            Loading your tickets...
          </div>
        </div>
      </div>

      <!-- Contact -->
      <div id="contact" class="tab-content">
        <div class="form-group"><input id="ticketSubject" placeholder="Subject"></div>
        <div class="form-group">
          <select id="ticketCategory">
            <option value="academic">Academic</option>
            <option value="technical">Technical</option>
            <option value="financial">Financial</option>
            <option value="general">General</option>
          </select>
        </div>
        <div class="form-group">
          <select id="ticketPriority">
            <option value="low">Low</option>
            <option value="medium">Medium</option>
            <option value="high">High</option>
          </select>
        </div>
        <div class="form-group">
          <textarea id="ticketDescription" placeholder="Description" rows="5"></textarea>
        </div>
        <button class="btn-submit" id="submitTicketBtn">Submit Ticket</button>
      </div>

      <!-- Chat -->
      <div id="chat" class="tab-content">
        <div class="chat-box">
          <div class="messages" id="messages">
            <div class="msg">Hello! How can I assist you today?</div>
          </div>
          <div class="chat-input">
            <input id="chatInput" placeholder="Type your message...">
            <button id="sendBtn">Send</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Custom Alert/Modal -->
  <div class="custom-alert-overlay" id="custom-alert-overlay"></div>
  <div class="custom-alert" id="custom-alert">
    <div id="custom-alert-message"></div>
    <button id="custom-alert-close" class="custom-alert-close">OK</button>
  </div>

  <!-- Ticket Details Modal -->
  <div class="custom-alert-overlay" id="ticket-modal-overlay"></div>
  <div class="custom-alert" id="ticket-modal">
    <h3 class="text-xl font-semibold mb-4 text-left" id="ticket-modal-subject"></h3>
    <div class="text-left mb-4">
      <p class="mb-2"><span class="font-medium">Status:</span> <span id="ticket-modal-status" class="status"></span></p>
      <p><span class="font-medium">Description:</span> <span id="ticket-modal-description"></span></p>
    </div>
    <hr class="border-gray-200 my-4" />
    <div class="text-left" id="ticket-modal-solution-section">
      <h4 class="font-semibold mb-2">Solution</h4>
      <p id="ticket-modal-solution" class="text-gray-700"></p>
    </div>
    <button id="ticket-modal-close" class="custom-alert-close">Close</button>
  </div>


  <script type="module">
    // Firebase imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp, onSnapshot, query, where, getDocs, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    setLogLevel('Debug');

    // Use global variables for appId and firebaseConfig
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = {
      apiKey: "AIzaSyDWVxMKaOjD10i87pX-kF6bPG8HbUNwGCY",
      authDomain: "unierp-79b03.firebaseapp.com",
      projectId: "unierp-79b03",
      storageBucket: "unierp-79b03.firebasestorage.app",
      messagingSenderId: "62493715652",
      appId: "1:62493715652:web:72e922ae35048dbd40ad91",
      measurementId: "G-GW9W07608T"
    };
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    let userId;

    let allFaqs = [];
    let filteredFaqs = [];
    let allTickets = [];

    // Custom alert function to replace window.alert
    function showAlert(message) {
      document.getElementById('custom-alert-message').textContent = message;
      document.getElementById('custom-alert-overlay').style.display = 'block';
      document.getElementById('custom-alert').style.display = 'block';
    }

    document.getElementById('custom-alert-close').addEventListener('click', () => {
      document.getElementById('custom-alert-overlay').style.display = 'none';
      document.getElementById('custom-alert').style.display = 'none';
    });

    // Function to show ticket details modal
    function showTicketDetailsModal(ticket) {
      document.getElementById('ticket-modal-subject').textContent = ticket.subject;
      document.getElementById('ticket-modal-status').textContent = ticket.status;
      document.getElementById('ticket-modal-status').className = `status ${ticket.status}`;
      document.getElementById('ticket-modal-description').textContent = ticket.description;

      const solutionSection = document.getElementById('ticket-modal-solution-section');
      const solutionText = document.getElementById('ticket-modal-solution');

      if (ticket.solution) {
        solutionSection.style.display = 'block';
        solutionText.textContent = ticket.solution;
      } else {
        solutionSection.style.display = 'none';
      }

      document.getElementById('ticket-modal-overlay').style.display = 'block';
      document.getElementById('ticket-modal').style.display = 'block';
    }

    document.getElementById('ticket-modal-close').addEventListener('click', () => {
      document.getElementById('ticket-modal-overlay').style.display = 'none';
      document.getElementById('ticket-modal').style.display = 'none';
    });

    // Function to render FAQs
    function renderFAQs(faqs) {
      const faqContainer = document.getElementById('faqContainer');

      if (faqs.length === 0) {
        faqContainer.innerHTML = '<div class="no-results">No FAQs found matching your search.</div>';
        return;
      }

      // Sort FAQs locally by 'order' property
      faqs.sort((a, b) => (a.order || Infinity) - (b.order || Infinity));

      let faqHTML = '';
      faqs.forEach(faq => {
        faqHTML += `
          <div class="faq-item" data-category="${faq.category || 'General'}">
            ${faq.category ? `<div class="faq-category">${faq.category}</div>` : ''}
            <strong>${faq.question}</strong>
            <p>${faq.answer}</p>
          </div>
        `;
      });

      faqContainer.innerHTML = faqHTML;

      // Add click handlers for FAQ items
      document.querySelectorAll('.faq-item strong').forEach(question => {
        question.addEventListener('click', (e) => {
          const item = e.target.closest('.faq-item');
          if (item) {
            item.classList.toggle('active');
          }
        });
      });
    }

    // Function to filter FAQs based on search
    function filterFAQs(searchTerm) {
      if (!searchTerm.trim()) {
        filteredFaqs = [...allFaqs];
      } else {
        const term = searchTerm.toLowerCase();
        filteredFaqs = allFaqs.filter(faq =>
          faq.question.toLowerCase().includes(term) ||
          faq.answer.toLowerCase().includes(term) ||
          (faq.category && faq.category.toLowerCase().includes(term))
        );
      }
      renderFAQs(filteredFaqs);
    }

    // Function to render tickets
    function renderTickets(tickets) {
      const ticketsContainer = document.getElementById('ticketsContainer');
      const openTicketsValue = document.getElementById('openTicketsValue');

      if (tickets.length === 0) {
        ticketsContainer.innerHTML = '<div class="no-tickets">You have no submitted tickets yet.</div>';
        openTicketsValue.textContent = '0';
        return;
      }

      let ticketsHTML = '';
      let openCount = 0;
      tickets.forEach(ticket => {
        if (ticket.status === 'open') {
          openCount++;
        }
        ticketsHTML += `
                <div class="ticket">
                    <div class="ticket-info">
                        <strong>${ticket.subject}</strong>
                        <span class="status ${ticket.status}">${ticket.status}</span>
                    </div>
                    <div class="btn view-details-btn" data-ticket-id="${ticket.id}">View Details</div>
                </div>
            `;
      });

      ticketsContainer.innerHTML = ticketsHTML;
      openTicketsValue.textContent = openCount;
    }

    // Function to submit support ticket
    async function submitTicket() {
      const subject = document.getElementById('ticketSubject').value.trim();
      const category = document.getElementById('ticketCategory').value;
      const priority = document.getElementById('ticketPriority').value;
      const description = document.getElementById('ticketDescription').value.trim();

      if (!subject || !description) {
        showAlert('Please fill in subject and description fields.');
        return;
      }

      try {
        const ticketsCollectionRef = collection(db, `tickets`);
        const newTicketRef = doc(ticketsCollectionRef);
        const ticketId = newTicketRef.id;

        await setDoc(newTicketRef, {
          ticketId: ticketId,
          userId: userId,
          userName: userId, // Using userId as a placeholder for userName
          subject: subject,
          category: category,
          priority: priority,
          status: 'open',
          description: description,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp(),
          assignedTo: userId,
          resolvedAt: null,
          feedback: null
        });

        showAlert('Support ticket submitted successfully! We will get back to you soon.');

        // Clear form
        document.getElementById('ticketSubject').value = '';
        document.getElementById('ticketDescription').value = '';
        document.getElementById('ticketCategory').value = 'academic';
        document.getElementById('ticketPriority').value = 'low';

      } catch (error) {
        console.error("Error submitting ticket:", error);
        showAlert('Error submitting ticket. Please try again.');
      }
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', function () {
      let isAuthReady = false;

      // Wait for authentication state to be ready
      onAuthStateChanged(auth, async (user) => {
        if (!isAuthReady) {
          if (user) {
            userId = user.uid;
          } else {
            // Sign in anonymously if no token is available
            try {
              if (typeof __initial_auth_token !== 'undefined') {
                const credential = await signInWithCustomToken(auth, __initial_auth_token);
                userId = credential.user.uid;
              } else {
                const credential = await signInAnonymously(auth);
                userId = credential.user.uid;
              }
            } catch (error) {
              console.error("Firebase Auth Error:", error);
            }
          }
          document.querySelector('.user-id-display').textContent = `User ID: ${userId}`;
          isAuthReady = true;

          // Setup real-time listeners for authenticated user
          const faqsRef = collection(db, 'faqs');
          onSnapshot(faqsRef, (querySnapshot) => {
            allFaqs = [];
            querySnapshot.forEach((doc) => {
              allFaqs.push({ id: doc.id, ...doc.data() });
            });
            filteredFaqs = [...allFaqs];
            renderFAQs(filteredFaqs);
          }, (error) => {
            console.error("Error listening to FAQs:", error);
            document.getElementById('faqContainer').innerHTML =
              '<div style="text-align: center; padding: 40px; color: #ef4444;">Error loading FAQs. Please try again later.</div>';
          });

          // Corrected query to use a top-level `tickets` collection and filter by userId
          const ticketsRef = collection(db, `tickets`);
          const userTicketsQuery = query(ticketsRef, where("userId", "==", userId));
          onSnapshot(userTicketsQuery, (querySnapshot) => {
            allTickets = [];
            querySnapshot.forEach((doc) => {
              allTickets.push({ id: doc.id, ...doc.data() });
            });
            renderTickets(allTickets);
          }, (error) => {
            console.error("Error listening to tickets:", error);
            document.getElementById('ticketsContainer').innerHTML =
              '<div class="no-tickets">Error loading tickets. Please try again.</div>';
          });
        }
      });

      // FAQ search
      document.getElementById('faqSearch').addEventListener('input', (e) => {
        filterFAQs(e.target.value);
      });

      // Submit ticket
      document.getElementById('submitTicketBtn').addEventListener('click', submitTicket);

      // Tab switching
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          document.getElementById(tab.dataset.tab).classList.add('active');
        });
      });

      // New delegated event listener for the "View Details" buttons
      document.getElementById('ticketsContainer').addEventListener('click', (e) => {
        if (e.target.classList.contains('view-details-btn')) {
          const ticketId = e.target.dataset.ticketId;
          const selectedTicket = allTickets.find(ticket => ticket.id === ticketId);
          if (selectedTicket) {
            showTicketDetailsModal(selectedTicket);
          }
        }
      });

      // Chat functionality
      const sendBtn = document.getElementById('sendBtn');
      const chatInput = document.getElementById('chatInput');
      const messages = document.getElementById('messages');

      function sendMessage() {
        if (chatInput.value.trim() !== "") {
          let msg = document.createElement('div');
          msg.className = "msg user";
          msg.textContent = chatInput.value;
          messages.appendChild(msg);
          chatInput.value = "";
          messages.scrollTop = messages.scrollHeight;

          // Simulate bot response
          setTimeout(() => {
            let botMsg = document.createElement('div');
            botMsg.className = "msg";
            botMsg.textContent = "Thank you for your message. A support representative will assist you shortly.";
            messages.appendChild(botMsg);
            messages.scrollTop = messages.scrollHeight;
          }, 1000);
        }
      }

      sendBtn.addEventListener('click', sendMessage);
      chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          sendMessage();
        }
      });
    });
  </script>
</body>

</html>